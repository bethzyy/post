# 画图模型选择原则

**创建日期:** 2026年1月27日
**更新日期:** 2026年1月27日

## 图像生成模型优先级

当需要生成图片时,必须按照以下优先级选择模型:

### 第一优先级: Gemini (通过antigravity代理)
- **模型**: `gemini-3-pro-image-4k`
- **优点**: 画质最高,构图最准确,细节最好
- **缺点**: 有配额限制(429错误),需要等待恢复
- **使用场景**: 所有重要图片生成任务
- **API**: 通过 `get_antigravity_client()` 调用
- **配置**:
  ```python
  client = get_antigravity_client()
  response = client.images.generate(
      model="gemini-3-pro-image-4k",
      prompt=prompt,
      size="1024x1024",
      n=1,
  )
  ```

### 第二优先级: Volcano/Seedream
- **模型**: `doubao-seedream-4-5-251128`
- **优点**: 无AI水印,画质较好,响应稳定
- **缺点**: 构图准确性略低于Gemini
- **使用场景**: Gemini不可用时的首选
- **API**: 通过 `get_volcano_client()` 调用
- **配置**:
  ```python
  client = get_volcano_client()
  response = client.images.generate(
      model="doubao-seedream-4-5-251128",
      prompt=prompt,
      size="2K",
      response_format="url",
      extra_body={
          "watermark": False,  # 关闭AI水印
      },
  )
  # 下载图片
  image_url = response.data[0].url
  img_response = requests.get(image_url, timeout=60)
  with open(filename, 'wb') as f:
      f.write(img_response.content)
  ```

### 第三优先级: Pollinations.ai
- **无模型名称**: 直接通过URL调用
- **优点**: 无配额限制,免费使用
- **缺点**: 画质一般,可能有网络延迟
- **使用场景**: 前两个模型都不可用时的备选
- **API**: 直接HTTP GET请求
- **配置**:
  ```python
  import requests

  url = f"https://image.pollinations.ai/prompt/{prompt}"
  response = requests.get(url, timeout=60)
  with open(filename, 'wb') as f:
      f.write(response.content)
  ```

## 错误处理策略

### Gemini 429错误处理
```python
try:
    response = client.images.generate(...)
except Exception as e:
    if "429" in str(e):
        print("[警告] Gemini配额耗尽,切换到Seedream")
        # 切换到Volcano/Seedream
    else:
        raise
```

### 自动重试机制
```python
def generate_with_priority(prompt, filename):
    """按优先级尝试生成图片"""

    # 1. 尝试Gemini
    try:
        return generate_with_gemini(prompt, filename)
    except Exception as e:
        if "429" not in str(e):
            raise

    # 2. 尝试Seedream
    try:
        return generate_with_seedream(prompt, filename)
    except Exception as e:
        print(f"[警告] Seedream失败: {e}")

    # 3. 尝试Pollinations
    try:
        return generate_with_pollinations(prompt, filename)
    except Exception as e:
        print(f"[错误] 所有模型均失败: {e}")
        raise
```

## 已知问题

### Gemini配额限制
- **问题**: Gemini免费账号约250次/天配额
- **现象**: 429 Too Many Requests
- **解决**: 等待约5分钟后自动恢复,或切换到其他模型

### Seedream模型名称
- **正确**: `doubao-seedream-4-5-251128`
- **错误**: `seedream-4.5` (会返回404错误)
- **注意**: 必须使用完整的模型名称

### 图片尺寸参数
- **Gemini**: `size="1024x1024"` 或 `size="2K"`
- **Seedream**: `size="2K"` (推荐)
- **Pollinations**: 在prompt中指定,如 `prompt + " 1024x1024"`

## 最佳实践

1. **优先使用Gemini**: 质量最好,构图最准确
2. **遇到429立即切换**: 不要等待,直接使用Seedream
3. **记录失败原因**: 便于后续优化
4. **批量生成考虑**: 大量图片建议使用Pollinations避免配额限制
5. **无水印需求**: 使用Seedream并设置 `watermark: False`

## 配置文件

所有API密钥已集中管理在 `.env` 文件:
```bash
ANTIGRAVITY_BASE_URL=http://127.0.0.1:8045/v1
ANTIGRAVITY_API_KEY=sk-xxx
VOLCANO_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
VOLCANO_API_KEY=xxx
```

## 参考代码

查看以下文件了解完整实现:
- `bird_painting_volcano.py` - Seedream使用示例
- `generate_food_article_seedream.py` - 无水印图片生成示例
- `labafestival_antigravity.py` - Gemini使用示例
- `generate_food_article_pollinations.py` - Pollinations使用示例

---

**重要**: 每次需要生成图片时,必须遵循此优先级原则!
