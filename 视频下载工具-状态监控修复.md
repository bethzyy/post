# è§†é¢‘ä¸‹è½½å·¥å…· - çŠ¶æ€ç›‘æ§ä¿®å¤

## ğŸ“… ä¿®å¤æ—¥æœŸ
2026å¹´1æœˆ29æ—¥ 20:10

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ
è§†é¢‘ä¸‹è½½å·¥å…·è™½ç„¶æˆåŠŸä¸‹è½½äº†è§†é¢‘æ–‡ä»¶,ä½†Webç•Œé¢ä¸€ç›´æ˜¾ç¤º"è¿è¡Œä¸­"çŠ¶æ€,æ— æ³•æ­£ç¡®æ˜¾ç¤ºä¸‹è½½å®ŒæˆçŠ¶æ€ã€‚

**å®é™…æƒ…å†µ:**
- è§†é¢‘æ–‡ä»¶åœ¨19:55å·²ç»ä¸‹è½½å®Œæˆ(1.5MB)
- Webç•Œé¢çŠ¶æ€APIä¸€ç›´è½®è¯¢åˆ°20:03+,ä»æ˜¾ç¤º"running"
- è¿›ç¨‹æ²¡æœ‰æ­£ç¡®é€€å‡º,å¯¼è‡´`poll()`ä¸€ç›´è¿”å›`None`

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: Pythonè¿›ç¨‹æœªæ­£ç¡®é€€å‡º
**ä½ç½®:** `video/baidu_video_downloader.py` çš„ `main()` å‡½æ•°

**åŸå› :**
```python
# âŒ é”™è¯¯çš„åšæ³•
def main():
    # ... ä¸‹è½½ä»£ç  ...
    if success:
        print("[æˆåŠŸ] è§†é¢‘ä¸‹è½½æˆåŠŸ!")
    else:
        print("[å¤±è´¥] è§†é¢‘ä¸‹è½½å¤±è´¥!")
    return  # âŒ returnä¸ä¼šé€€å‡ºPythonè¿›ç¨‹,åªæ˜¯è¿”å›main()å‡½æ•°
```

åœ¨Pythonä¸­,`main()`å‡½æ•°ä½¿ç”¨`return`åªä¼šä»å‡½æ•°è¿”å›,ä¸ä¼šé€€å‡ºæ•´ä¸ªPythonè¿›ç¨‹ã€‚è¿™å¯¼è‡´è¿›ç¨‹ä¸€ç›´æŒ‚èµ·,`process.poll()`ä¸€ç›´è¿”å›`None`ã€‚

### é—®é¢˜2: è¾“å‡ºè¯»å–å¯èƒ½é˜»å¡
**ä½ç½®:** `tool_manager.py` çš„ `/api/status` è·¯ç”±

**åŸå› :**
```python
# âš ï¸ æ½œåœ¨é—®é¢˜
if return_code is None:
    # è¿›ç¨‹ä»åœ¨è¿è¡Œ
    return jsonify({'status': 'running', 'output': 'æ­£åœ¨è¿è¡Œ...'})
else:
    # è¿›ç¨‹å·²ç»“æŸ
    stdout, stderr = process.communicate()  # âš ï¸ å¯èƒ½é˜»å¡
```

å½“è¿›ç¨‹ç»“æŸåè°ƒç”¨`communicate()`æ—¶,å¦‚æœæ²¡æœ‰æ•°æ®æˆ–ç®¡é“å·²å…³é—­,å¯èƒ½ä¼šå¯¼è‡´è¶…æ—¶æˆ–é˜»å¡ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ä½¿ç”¨ sys.exit() æ­£ç¡®é€€å‡ºè¿›ç¨‹

**ä¿®æ”¹æ–‡ä»¶:** `video/baidu_video_downloader.py`

**ä¿®æ”¹å†…å®¹:**
```python
# âœ… æ­£ç¡®çš„åšæ³•
import sys

def main():
    # ... Webæ¨¡å¼ä»£ç  ...
    if success:
        print("\n[æˆåŠŸ] è§†é¢‘ä¸‹è½½æˆåŠŸ!")
    else:
        print("\n[å¤±è´¥] è§†é¢‘ä¸‹è½½å¤±è´¥!")
    sys.exit(0 if success else 1)  # âœ… æ˜ç¡®é€€å‡ºè¿›ç¨‹

# âœ… æ‰€æœ‰é€€å‡ºç‚¹éƒ½ä½¿ç”¨ sys.exit()
if not url:
    print("\n[é”™è¯¯] æœªæ¥æ”¶åˆ°è§†é¢‘URL")
    sys.exit(1)  # âœ… é”™è¯¯é€€å‡º

# âœ… å‘½ä»¤è¡Œæ¨¡å¼ä¹Ÿä½¿ç”¨ sys.exit()
if choice not in ['y', 'yes', 'æ˜¯']:
    print("\n[é€€å‡º] è¯·å…ˆå®‰è£…Selenium")
    sys.exit(1)  # âœ… ç”¨æˆ·é€€å‡º
```

**é€€å‡ºç è¯´æ˜:**
- `sys.exit(0)` - æˆåŠŸé€€å‡º
- `sys.exit(1)` - å¤±è´¥é€€å‡º

### ä¿®å¤2: ä¼˜åŒ–çŠ¶æ€æ£€æŸ¥API

**ä¿®æ”¹æ–‡ä»¶:** `tool_manager.py`

**ä¿®æ”¹å†…å®¹:**
```python
@app.route('/api/status/<process_id>')
def api_status(process_id):
    # ... å‰é¢ä»£ç  ...

    if return_code is None:
        # âœ… è¿›ç¨‹ä»åœ¨è¿è¡Œ - å°è¯•è¯»å–å·²äº§ç”Ÿçš„è¾“å‡º(éé˜»å¡)
        try:
            import fcntl
            fd = process.stdout.fileno()
            fl = fcntl.fcntl(fd, fcntl.F_GETFL)
            fcntl.fcntl(fd, fcntl.F_SETFL, fl | os.O_NONBLOCK)

            try:
                output = process.stdout.read()
                if output:
                    proc_info['output'] += output.decode('utf-8', errors='ignore')
            except:
                pass
        except:
            # Windowsä¸æ”¯æŒfcntl,è·³è¿‡
            pass

        return jsonify({
            'status': 'running',
            'output': proc_info.get('output', 'æ­£åœ¨è¿è¡Œ...'),  # âœ… è¿”å›å·²ç¼“å­˜çš„è¾“å‡º
            ...
        })
    else:
        # âœ… è¿›ç¨‹å·²ç»“æŸ - ä½¿ç”¨communicate()è·å–å‰©ä½™è¾“å‡º
        try:
            stdout, stderr = process.communicate(timeout=5)  # âœ… æ·»åŠ è¶…æ—¶
            output = stdout.decode('utf-8', errors='ignore')
            error = stderr.decode('utf-8', errors='ignore')

            if error:
                output += f'\n[é”™è¯¯è¾“å‡º]\n{error}'

            # âœ… è¿½åŠ åˆ°ä¹‹å‰çš„è¾“å‡º
            if proc_info.get('output'):
                output = proc_info['output'] + output
        except:
            # âœ… communicate()è¶…æ—¶æˆ–å¤±è´¥,ä½¿ç”¨å·²ç¼“å­˜çš„è¾“å‡º
            output = proc_info.get('output', 'è¾“å‡ºè¯»å–å¤±è´¥')

        return jsonify({
            'status': 'completed' if return_code == 0 else 'failed',
            'output': output,
            ...
        })
```

**æ”¹è¿›ç‚¹:**
1. âœ… æ·»åŠ è¾“å‡ºç¼“å­˜æœºåˆ¶ - `proc_info['output']`
2. âœ… æ·»åŠ è¶…æ—¶å‚æ•° - `communicate(timeout=5)`
3. âœ… æ·»åŠ å¼‚å¸¸å¤„ç† - å¤±è´¥æ—¶ä½¿ç”¨å·²ç¼“å­˜è¾“å‡º
4. âœ… Windowså…¼å®¹æ€§å¤„ç† - `fcntl`ä»…åœ¨Unixç³»ç»Ÿå¯ç”¨

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| è¿›ç¨‹é€€å‡º | `return` - ä¸é€€å‡º | `sys.exit()` - æ­£ç¡®é€€å‡º |
| é€€å‡ºç  | æ— æ˜ç¡®é€€å‡ºç  | 0=æˆåŠŸ,1=å¤±è´¥ |
| çŠ¶æ€æ£€æµ‹ | ä¸€ç›´æ˜¾ç¤º"è¿è¡Œä¸­" | æ­£ç¡®æ˜¾ç¤º"å·²å®Œæˆ/å¤±è´¥" |
| è¾“å‡ºè¯»å– | å¯èƒ½é˜»å¡ | éé˜»å¡+è¶…æ—¶ä¿æŠ¤ |
| ç¼“å­˜æœºåˆ¶ | æ—  | è¾“å‡ºå®æ—¶ç¼“å­˜ |

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
19:54:45 - ç”¨æˆ·ç‚¹å‡»"è¿è¡Œå·¥å…·"
19:55:xx - è§†é¢‘ä¸‹è½½å®Œæˆ(æ–‡ä»¶å·²ä¿å­˜)
19:55-20:03 - Webç•Œé¢ä»æ˜¾ç¤º"è¿è¡Œä¸­"
âŒ è¿›ç¨‹æœªé€€å‡º,çŠ¶æ€æ£€æµ‹å¤±æ•ˆ
```

### ä¿®å¤å
```
xx:xx:xx - ç”¨æˆ·ç‚¹å‡»"è¿è¡Œå·¥å…·"
xx:xx:xx - è§†é¢‘ä¸‹è½½å®Œæˆ(æ–‡ä»¶å·²ä¿å­˜)
xx:xx:xx - è¿›ç¨‹è°ƒç”¨ sys.exit(0)
xx:xx:xx - poll() æ£€æµ‹åˆ°è¿›ç¨‹ç»“æŸ,returncode=0
xx:xx:xx - communicate() è¯»å–æœ€ç»ˆè¾“å‡º
xx:xx:xx - APIè¿”å› status='completed', output=[å®Œæ•´æ—¥å¿—]
âœ… Webç•Œé¢æ­£ç¡®æ˜¾ç¤º"å·²å®Œæˆ"çŠ¶æ€
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### Pythonè¿›ç¨‹é€€å‡ºæœºåˆ¶

**`return` vs `sys.exit()`:**
```python
# âŒ return - åªé€€å‡ºå‡½æ•°,ä¸é€€å‡ºè¿›ç¨‹
def main():
    return
# è¿›ç¨‹ç»§ç»­è¿è¡Œ...

# âœ… sys.exit() - é€€å‡ºæ•´ä¸ªè¿›ç¨‹
import sys
def main():
    sys.exit(0)
# è¿›ç¨‹ç«‹å³é€€å‡º,è¿”å›ç =0
```

### subprocess.Popen() çŠ¶æ€æ£€æµ‹

**`poll()` æ–¹æ³•:**
- è¿”å› `None` - è¿›ç¨‹ä»åœ¨è¿è¡Œ
- è¿”å› `0` - è¿›ç¨‹æˆåŠŸé€€å‡º
- è¿”å› `é0` - è¿›ç¨‹å¼‚å¸¸é€€å‡º(é€€å‡ºç )

**`communicate()` æ–¹æ³•:**
- è¯»å–è¿›ç¨‹çš„ stdout å’Œ stderr
- **é˜»å¡ç›´åˆ°è¿›ç¨‹ç»“æŸ**
- å¯èƒ½è¶…æ—¶,éœ€è¦æ·»åŠ  `timeout` å‚æ•°

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `video/baidu_video_downloader.py`
**ä¿®æ”¹è¡Œæ•°:** 5å¤„

- Line 340: `return` â†’ `sys.exit(1)`
- Line 363: `return` â†’ `sys.exit(0 if success else 1)`
- Line 367: `return` â†’ `sys.exit(1)`
- Line 380: `return` â†’ `sys.exit(1)`
- Line 398: `return` â†’ `sys.exit(1)`
- Line 415: æ·»åŠ  `sys.exit(0 if success else 1)`

### 2. `tool_manager.py`
**ä¿®æ”¹è¡Œæ•°:** Lines 366-425

- æ·»åŠ è¾“å‡ºç¼“å­˜æœºåˆ¶
- æ·»åŠ éé˜»å¡è¾“å‡ºè¯»å–
- æ·»åŠ  communicate() è¶…æ—¶
- æ·»åŠ å¼‚å¸¸å¤„ç†

## âœ… æµ‹è¯•éªŒè¯

### é¢„æœŸè¡Œä¸º
1. âœ… è§†é¢‘ä¸‹è½½å®Œæˆå,è¿›ç¨‹ç«‹å³é€€å‡º
2. âœ… Webç•Œé¢åœ¨ä¸‹æ¬¡çŠ¶æ€æ£€æŸ¥æ—¶æ˜¾ç¤º"å·²å®Œæˆ"
3. âœ… æ˜¾ç¤ºå®Œæ•´çš„ä¸‹è½½æ—¥å¿—(åŒ…æ‹¬Seleniumå¯åŠ¨ã€ä¸‹è½½è¿›åº¦ç­‰)
4. âœ… é€€å‡ºç æ­£ç¡®(æˆåŠŸ=0,å¤±è´¥=1)

### éªŒè¯æ–¹æ³•
```bash
# 1. è¿è¡Œå·¥å…·
åœ¨Webç•Œé¢: é€‰æ‹©"è§†é¢‘ä¸‹è½½å·¥å…·" â†’ è¾“å…¥URL â†’ ç‚¹å‡»"è¿è¡Œå·¥å…·"

# 2. è§‚å¯Ÿæ—¥å¿—
[Webæ¨¡å¼] URL: ...
[Selenium] æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...
[ä¸‹è½½] å¼€å§‹ä¸‹è½½è§†é¢‘...
[è¿›åº¦] 100%
[æˆåŠŸ] è§†é¢‘ä¸‹è½½å®Œæˆ!

# 3. æ£€æŸ¥çŠ¶æ€
åº”è¯¥è‡ªåŠ¨æ˜¾ç¤º: "âœ… å·²å®Œæˆ"
è€Œä¸æ˜¯: "â³ è¿è¡Œä¸­"
```

## ğŸ‰ æ€»ç»“

### é—®é¢˜æ ¹æº
Pythonè„šæœ¬ä½¿ç”¨`return`é€€å‡º`main()`å‡½æ•°,å¯¼è‡´è¿›ç¨‹æœªçœŸæ­£é€€å‡º,`poll()`ä¸€ç›´è¿”å›`None`ã€‚

### è§£å†³æ–¹æ¡ˆ
1. **æ ¹æœ¬è§£å†³:** æ‰€æœ‰é€€å‡ºç‚¹ä½¿ç”¨`sys.exit()`,ç¡®ä¿è¿›ç¨‹æ­£ç¡®é€€å‡º
2. **å¢å¼ºé²æ£’æ€§:** ä¼˜åŒ–çŠ¶æ€API,æ·»åŠ è¾“å‡ºç¼“å­˜ã€è¶…æ—¶ä¿æŠ¤ã€å¼‚å¸¸å¤„ç†

### ä¿®å¤ç»“æœ
- âœ… è¿›ç¨‹æ­£ç¡®é€€å‡º
- âœ… çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- âœ… è¾“å‡ºå®Œæ•´è¯»å–
- âœ… ç”¨æˆ·ä½“éªŒæ”¹å–„

**Flaskå·²è‡ªåŠ¨é‡è½½æ‰€æœ‰æ›´æ”¹,åˆ·æ–°æµè§ˆå™¨å³å¯ç”Ÿæ•ˆ!**

---

**ä¿®å¤æ—¶é—´:** 2026-01-29 20:10
**çŠ¶æ€:** âœ… å·²ä¿®å¤
**ç‰ˆæœ¬:** v2.1
