<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå‘æ–‡å·¥å…·ç®¡ç†å™¨ v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: #1e1e2e;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .header {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
        }

        .stat-item {
            background: rgba(255,255,255,0.15);
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        /* ä¸»å®¹å™¨ - ä¸‰æ å¸ƒå±€ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* å·¦ä¾§æ ‘çŠ¶å¯¼èˆª */
        .sidebar {
            width: 400px;
            min-width: 250px;
            max-width: 600px;
            background: #252538;
            border-right: 1px solid #3a3a5c;
            display: flex;
            flex-direction: column;
            resize: horizontal;
            overflow: hidden;
        }

        /* åˆ†éš”æ¡ */
        .resizer {
            width: 5px;
            background: #3a3a5c;
            cursor: col-resize;
            transition: background 0.2s;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .resizer:hover,
        .resizer.resizing {
            background: #5a67d8;
        }

        .resizer::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: #5a67d8;
            border-radius: 1px;
            opacity: 0.5;
        }

        .resizer:hover::after,
        .resizer.resizing::after {
            opacity: 1;
        }

        .sidebar-header {
            padding: 15px 20px;
            background: #2d2d45;
            font-weight: 600;
            font-size: 1.1em;
            border-bottom: 1px solid #3a3a5c;
            color: #c5c5e0;
        }

        .tree-view {
            flex: 1;
            padding: 10px 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        .tree-view::-webkit-scrollbar {
            width: 8px;
        }

        .tree-view::-webkit-scrollbar-track {
            background: #1e1e2e;
        }

        .tree-view::-webkit-scrollbar-thumb {
            background: #5a67d8;
            border-radius: 4px;
        }

        .tree-view::-webkit-scrollbar-thumb:hover {
            background: #6b46c1;
        }

        /* æ ‘èŠ‚ç‚¹æ ·å¼ */
        .tree-node {
            cursor: pointer;
            user-select: none;
        }

        .tree-category {
            padding: 12px 15px 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #c5c5e0;
            border-bottom: 1px solid #3a3a5c;
            transition: background 0.2s;
        }

        .tree-category:hover {
            background: #2d2d45;
        }

        .tree-category.expanded {
            background: #3a3a5c;
        }

        .tree-icon {
            font-size: 1.2em;
            transition: transform 0.2s;
        }

        .tree-category.expanded .tree-icon {
            transform: rotate(90deg);
        }

        .tree-count {
            margin-left: auto;
            background: #5a67d8;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            color: #e0e0e0;
        }

        .tree-tools {
            display: none;
            background: #1e1e2e;
        }

        .tree-category.expanded + .tree-tools {
            display: block;
        }

        .tree-tool {
            padding: 10px 15px 10px 50px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            color: #ddd;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .tree-tool span:first-child {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .tree-tool:hover {
            background: #2d2d45;
            border-left-color: #5a67d8;
        }

        .tree-tool.selected {
            background: #5a67d8;
            border-left-color: #a5b4fc;
            color: white;
        }

        .tree-tool.running {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.15);
        }

        .tree-tool.completed {
            border-left-color: #17a2b8;
        }

        .tree-tool.failed {
            border-left-color: #dc3545;
        }

        .tree-run-btn {
            margin-left: auto;
            background: #5a67d8;
            border: none;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
        }

        .tree-tool:hover .tree-run-btn,
        .tree-tool:hover .tree-delete-btn {
            display: block;
        }

        .tree-delete-btn {
            background: #dc3545;
            border: none;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
            margin-left: 5px;
        }

        .tree-delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .tree-run-btn:hover {
            background: #6b46c1;
            transform: scale(1.05);
        }

        .tree-run-btn.running {
            background: #48bb78;
            display: block !important;
        }

        .tree-status-icon {
            margin-left: 5px;
            font-size: 1em;
        }

        /* ä¸­é—´å†…å®¹åŒº */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e2e;
            border-right: 1px solid #3a3a5c;
        }

        .content-header {
            padding: 20px;
            background: #252538;
            border-bottom: 1px solid #3a3a5c;
        }

        .content-header h2 {
            color: #c5c5e0;
            margin-bottom: 10px;
        }

        .content-header p {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .tool-details {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .detail-card {
            background: #252538;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #3a3a5c;
        }

        .detail-card h3 {
            color: #c5c5e0;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .meta-info {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .meta-item {
            background: #1e1e2e;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #3a3a5c;
        }

        .meta-label {
            color: #9ca3af;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .meta-value {
            color: #c5c5e0;
            font-weight: 600;
        }

        .run-button {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(90, 103, 216, 0.4);
        }

        .run-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .run-button.running {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        /* å³ä¾§æ—¥å¿—åŒº */
        .log-panel {
            width: 450px;
            min-width: 300px;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            background: #1a1a24;
            resize: horizontal;
            overflow: hidden;
        }

        .log-header {
            padding: 15px 20px;
            background: #252538;
            border-bottom: 1px solid #3a3a5c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header h3 {
            color: #c5c5e0;
            font-size: 1em;
        }

        .clear-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .clear-button:hover {
            background: #c82333;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            background: #252538;
            border-left: 3px solid #5a67d8;
        }

        .log-entry.info {
            border-left-color: #4299e1;
            background: rgba(66, 153, 225, 0.1);
        }

        .log-entry.success {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .log-entry.error {
            border-left-color: #f56565;
            background: rgba(245, 101, 101, 0.1);
        }

        .log-entry.warning {
            border-left-color: #ecc94b;
            background: rgba(236, 201, 75, 0.1);
        }

        .log-time {
            color: #9ca3af;
            font-size: 0.85em;
            margin-right: 8px;
        }

        .log-message {
            color: #c5c5e0;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e2e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3a3a5c;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }

        /* ä¸»é¢˜è¾“å…¥æ¡† */
        .theme-input-container {
            margin-top: 15px;
        }

        .theme-input {
            width: 100%;
            padding: 12px;
            background: #1e1e2e;
            border: 1px solid #3a3a5c;
            border-radius: 5px;
            color: #c5c5e0;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .theme-input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .example-themes {
            color: #9ca3af;
            font-size: 0.85em;
            line-height: 1.8;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.running {
            background: #28a745;
        }

        .status-indicator.completed {
            background: #17a2b8;
            animation: none;
        }

        .status-indicator.failed {
            background: #dc3545;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Tooltipæ ·å¼ */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            padding: 8px 12px;
            background: #3a3a5c;
            color: #e0e0e0;
            border-radius: 5px;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            pointer-events: none;
            max-width: 400px;
            white-space: normal;
            width: max-content;
        }

        .update-docs-button {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .update-docs-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #6b46c1, #5a67d8);
        }

        .update-docs-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="header">
        <h1>ğŸ“ AIå‘æ–‡å·¥å…·ç®¡ç†å™¨ v2.0</h1>
        <div class="header-stats">
            <div class="stat-item">ğŸ“ <span id="total-categories">0</span> åˆ†ç±»</div>
            <div class="stat-item">ğŸ”§ <span id="total-tools">0</span> å·¥å…·</div>
            <div class="stat-item">ğŸ”„ <span id="running-count">0</span> è¿è¡Œä¸­</div>
            <button class="update-docs-button" onclick="updateDocumentation()" title="é‡æ–°ç”Ÿæˆæ‰€æœ‰å·¥å…·çš„æ–‡æ¡£">ğŸ“– æ›´æ–°æ–‡æ¡£</button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§æ ‘çŠ¶å¯¼èˆª -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">ğŸ“‚ å·¥å…·åˆ†ç±»</div>
            <div class="tree-view" id="tree-view">
                <!-- æ ‘çŠ¶ç»“æ„å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åˆ†éš”æ¡1 -->
        <div class="resizer" id="resizer-1"></div>

        <!-- ä¸­é—´å†…å®¹åŒº -->
        <div class="content-area">
            <div class="content-header">
                <h2 id="tool-title">è¯·é€‰æ‹©ä¸€ä¸ªå·¥å…·</h2>
                <p id="tool-description">ä»å·¦ä¾§ç›®å½•æ ‘ä¸­é€‰æ‹©è¦è¿è¡Œçš„å·¥å…·</p>
            </div>
            <div class="tool-details" id="tool-details">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘ˆ</div>
                    <p>ç‚¹å‡»å·¦ä¾§ç›®å½•é€‰æ‹©å·¥å…·</p>
                </div>
            </div>
        </div>

        <!-- åˆ†éš”æ¡2 -->
        <div class="resizer" id="resizer-2"></div>

        <!-- å³ä¾§æ—¥å¿—åŒº -->
        <div class="log-panel" id="log-panel">
            <div class="log-header">
                <h3>ğŸ“‹ è¿è¡Œæ—¥å¿—</h3>
                <button class="clear-button" onclick="clearLogs()">æ¸…ç©º</button>
            </div>
            <div class="log-content" id="log-content">
                <div class="log-entry info">
                    <span class="log-time">[ç³»ç»Ÿ]</span>
                    <span class="log-message">æ¬¢è¿ä½¿ç”¨AIå‘æ–‡å·¥å…·ç®¡ç†å™¨</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentTool = null;
        let currentProcessId = null;
        let statusCheckInterval = null;

        // å·¥å…·æ•°æ®
        const toolsData = {{ tools|tojson }};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            buildTreeView();
            updateStats();
            initResizers();
        });

        // åˆå§‹åŒ–æ‹–åŠ¨è°ƒæ•´å¤§å°åŠŸèƒ½
        function initResizers() {
            const resizer1 = document.getElementById('resizer-1');
            const sidebar = document.getElementById('sidebar');
            const contentArea = document.querySelector('.content-area');

            const resizer2 = document.getElementById('resizer-2');
            const logPanel = document.getElementById('log-panel');

            // åˆ†éš”æ¡1 - è°ƒæ•´å·¦ä¾§è¾¹æ å®½åº¦
            initResizer(resizer1, sidebar, contentArea, 'left');

            // åˆ†éš”æ¡2 - è°ƒæ•´å³ä¾§æ—¥å¿—é¢æ¿å®½åº¦
            initResizer(resizer2, logPanel, contentArea, 'right');
        }

        function initResizer(resizer, targetPanel, siblingPanel, direction) {
            let startX, startWidth, siblingStartWidth;

            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                startX = e.clientX;
                startWidth = targetPanel.offsetWidth;
                siblingStartWidth = siblingPanel.offsetWidth;

                resizer.classList.add('resizing');

                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            });

            function resize(e) {
                const dx = e.clientX - startX;

                if (direction === 'left') {
                    // è°ƒæ•´å·¦ä¾§é¢æ¿
                    const newWidth = startWidth + dx;
                    if (newWidth >= 250 && newWidth <= 600) {
                        targetPanel.style.width = newWidth + 'px';
                    }
                } else if (direction === 'right') {
                    // è°ƒæ•´å³ä¾§é¢æ¿
                    const newWidth = startWidth - dx;
                    if (newWidth >= 300 && newWidth <= 800) {
                        targetPanel.style.width = newWidth + 'px';
                    }
                }
            }

            function stopResize() {
                resizer.classList.remove('resizing');
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // æ„å»ºæ ‘çŠ¶è§†å›¾
        function buildTreeView() {
            const treeView = document.getElementById('tree-view');
            treeView.innerHTML = '';

            for (const [category, tools] of Object.entries(toolsData)) {
                // åˆ›å»ºåˆ†ç±»èŠ‚ç‚¹
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'tree-node';

                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'tree-category';
                categoryHeader.innerHTML = `
                    <span class="tree-icon">â–¶</span>
                    <span>${category}</span>
                    <span class="tree-count">${tools.length}</span>
                `;

                // ç‚¹å‡»å±•å¼€/æŠ˜å 
                categoryHeader.onclick = () => {
                    categoryHeader.classList.toggle('expanded');
                };

                // åˆ›å»ºå·¥å…·åˆ—è¡¨
                const toolsDiv = document.createElement('div');
                toolsDiv.className = 'tree-tools';

                tools.forEach(tool => {
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'tree-tool';
                    toolDiv.dataset.filename = tool.filename;
                    toolDiv.dataset.tooltip = tool.description;

                    // å·¥å…·åç§° - æå–ç®€åŒ–ç‰ˆæœ¬çš„åŠŸèƒ½æè¿°
                    // æ ¼å¼: "ç±»å‹ - åç§° (è¯¦ç»†è¯´æ˜)" -> "åç§°"
                    let shortName = tool.description;
                    if (shortName.includes(' - ')) {
                        // ç§»é™¤ç±»å‹å‰ç¼€
                        shortName = shortName.split(' - ')[1];
                    }
                    if (shortName.includes(' (')) {
                        // ç§»é™¤æ‹¬å·ä¸­çš„è¯¦ç»†è¯´æ˜
                        shortName = shortName.split(' (')[0];
                    }

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = shortName;
                    nameSpan.title = tool.description;
                    toolDiv.appendChild(nameSpan);

                    // è¿è¡ŒæŒ‰é’®
                    const runBtn = document.createElement('button');
                    runBtn.className = 'tree-run-btn';
                    runBtn.textContent = 'â–¶';
                    runBtn.title = 'è¿è¡Œå·¥å…·';
                    runBtn.onclick = (e) => {
                        e.stopPropagation();
                        runToolDirect(tool, toolDiv, runBtn);
                    };
                    toolDiv.appendChild(runBtn);

                    // åˆ é™¤æŒ‰é’®
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'tree-delete-btn';
                    deleteBtn.textContent = 'ğŸ—‘';
                    deleteBtn.title = 'åˆ é™¤å·¥å…·';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteTool(tool, toolDiv);
                    };
                    toolDiv.appendChild(deleteBtn);

                    // ç‚¹å‡»é€‰æ‹©
                    toolDiv.onclick = () => {
                        selectTool(tool, toolDiv);
                    };

                    toolsDiv.appendChild(toolDiv);
                });

                categoryDiv.appendChild(categoryHeader);
                categoryDiv.appendChild(toolsDiv);
                treeView.appendChild(categoryDiv);
            }
        }

        // è¿è¡Œå·¥å…·(ä»å·¦ä¾§æ ‘ç›´æ¥è¿è¡Œ)
        async function runToolDirect(tool, element, btn) {
            btn.disabled = true;
            btn.textContent = 'â³';
            btn.classList.add('running');

            // åŒæ—¶é€‰ä¸­è¯¥å·¥å…·
            selectTool(tool, element);

            // æ·»åŠ æ—¥å¿—
            addLog('info', `å¼€å§‹è¿è¡Œ: ${tool.description}`);

            try {
                const requestData = {
                    filename: tool.filename
                };

                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.success) {
                    currentProcessId = data.process_id;
                    addLog('success', `å·¥å…·å·²å¯åŠ¨`);

                    // æ›´æ–°æ ‘èŠ‚ç‚¹çŠ¶æ€
                    element.classList.add('running');
                    btn.textContent = 'ğŸ”„';

                    // å¼€å§‹æ£€æŸ¥çŠ¶æ€
                    checkStatusDirect(tool, element, btn);

                } else {
                    addLog('error', `å¯åŠ¨å¤±è´¥: ${data.error}`);
                    btn.disabled = false;
                    btn.textContent = 'â–¶ è¿è¡Œ';
                    btn.classList.remove('running');
                }

            } catch (error) {
                addLog('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'â–¶ è¿è¡Œ';
                btn.classList.remove('running');
            }
        }

        // æ£€æŸ¥è¿è¡ŒçŠ¶æ€(ç›´æ¥è¿è¡Œç‰ˆæœ¬)
        async function checkStatusDirect(tool, element, btn) {
            if (!currentProcessId) return;

            try {
                const response = await fetch(`/api/status/${currentProcessId}`);
                const data = await response.json();

                if (data.success) {
                    if (data.status === 'running') {
                        statusCheckInterval = setTimeout(() => checkStatusDirect(tool, element, btn), 2000);
                    } else {
                        // å®Œæˆ
                        clearInterval(statusCheckInterval);

                        element.classList.remove('running');
                        element.classList.add(data.status);

                        if (data.status === 'completed') {
                            addLog('success', `âœ“ è¿è¡Œå®Œæˆ! è€—æ—¶: ${data.elapsed_time}ç§’`);
                            btn.textContent = 'âœ“';
                            btn.style.background = '#48bb78';
                            if (data.output) {
                                addLog('info', 'è¾“å‡ºç»“æœ:\n' + data.output);

                                // æ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„HTMLæ–‡ä»¶å¹¶æ·»åŠ å¯ç‚¹å‡»é“¾æ¥
                                const htmlMatch = data.output.match(/\[OUTPUT\] HTML: (.+\.html)/);
                                if (htmlMatch) {
                                    const htmlFile = htmlMatch[1].trim();
                                    const viewUrl = `/view/article/${htmlFile}`;
                                    addLogWithLink('success', `ğŸ“„ ç‚¹å‡»æŸ¥çœ‹æ–‡ç« : `, htmlFile, viewUrl);
                                }
                            }
                        } else {
                            addLog('error', `âœ— è¿è¡Œå¤±è´¥`);
                            btn.textContent = 'âœ—';
                            btn.style.background = '#f56565';
                            if (data.output) {
                                addLog('error', 'é”™è¯¯è¾“å‡º:\n' + data.output);
                            }
                        }

                        btn.disabled = false;
                        updateStats();

                        // 3ç§’åé‡ç½®æŒ‰é’®
                        setTimeout(() => {
                            btn.textContent = 'â–¶ è¿è¡Œ';
                            btn.style.background = '';
                            element.classList.remove(data.status);
                        }, 3000);
                    }
                }

            } catch (error) {
                addLog('error', `çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        // é€‰æ‹©å·¥å…·
        async function selectTool(tool, element) {
            // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tree-tool').forEach(el => {
                el.classList.remove('selected');
            });

            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');

            currentTool = tool;

            // æ›´æ–°å†…å®¹åŒº
            document.getElementById('tool-title').textContent = tool.description;
            document.getElementById('tool-description').textContent = `æ–‡ä»¶: ${tool.filename}`;

            const detailsDiv = document.getElementById('tool-details');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            detailsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #c5c5e0;">ğŸ“Š æ­£åœ¨åŠ è½½å·¥å…·è¯¦æƒ…...</div>';

            // è§£ææè¿°ï¼Œè·å–åŠŸèƒ½åç§°å’Œè¯¦ç»†è¯´æ˜
            const descParts = tool.description.split(' - ');
            const toolName = descParts[0];
            const toolDesc = descParts.length > 1 ? descParts.slice(1).join(' - ') : 'æš‚æ— è¯¦ç»†æè¿°';

            // ä»æ–‡æ¡£APIè·å–è¯¦ç»†ä¿¡æ¯
            let docInfo = null;
            try {
                const response = await fetch('/api/documentation');
                const data = await response.json();
                if (data.success && data.documentation) {
                    // ä»æ–‡ä»¶è·¯å¾„æå–åˆ†ç±»å’Œæ–‡ä»¶å
                    const pathParts = tool.filename.replace(/\\/g, '/').split('/');
                    const category = pathParts[0];
                    const filename = pathParts[pathParts.length - 1];

                    if (data.documentation[category] && data.documentation[category][filename]) {
                        docInfo = data.documentation[category][filename];
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error);
            }

            // ä¼˜å…ˆä½¿ç”¨ details ä¸­çš„è¯¦ç»†ä¿¡æ¯
            let toolDetails = tool.details || {};

            // æå–è¯¦ç»†ä¿¡æ¯
            let detailedDescription = toolDetails['åŠŸèƒ½'] || toolDesc;
            let techStack = toolDetails['æŠ€æœ¯æ ˆ'] || [];

            let html = `
                <div class="detail-card">
                    <h3>ğŸ“Š å·¥å…·ä¿¡æ¯</h3>
                    <div class="meta-info">
                        <div class="meta-item">
                            <div class="meta-label">æ–‡ä»¶å</div>
                            <div class="meta-value">${tool.filename}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">æœ€åä¿®æ”¹</div>
                            <div class="meta-value">${tool.modified}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">æ–‡ä»¶å¤§å°</div>
                            <div class="meta-value">${(tool.size / 1024).toFixed(1)} KB</div>
                        </div>
                    </div>

                    <div class="meta-item" style="margin-top: 12px;">
                        <div class="meta-label">åŠŸèƒ½è¯´æ˜</div>
                        <div style="color: #c5c5e0; line-height: 1.8; margin-top: 6px; padding: 15px; background: #1e1e2e; border-radius: 8px; border-left: 4px solid #5a67d8; white-space: pre-wrap; font-size: 0.95em;">
                            ${detailedDescription}
                        </div>
                    </div>
            `;

            // å¦‚æœæ˜¯èŠ‚æ—¥å›¾åƒç”Ÿæˆå™¨,æ·»åŠ ä¸»é¢˜è¾“å…¥æ¡†
            if (tool.filename === 'picture/generate_festival_images.py') {
                html += `
                    <div class="theme-input-container">
                        <input
                            type="text"
                            class="theme-input"
                            id="theme-input"
                            placeholder="è¾“å…¥ç”Ÿæˆä¸»é¢˜ï¼ˆä¾‹å¦‚ï¼šæ˜¥èŠ‚ä¸»é¢˜ - ä¸­å›½é£æ°´å½©ç”»ï¼‰"
                        >
                        <div class="example-themes">
                            <strong>ç¤ºä¾‹ä¸»é¢˜ï¼š</strong><br>
                            â€¢ æ˜¥èŠ‚ä¸»é¢˜ - ä¸­å›½é£æ°´å½©ç”»ï¼Œçº¢è‰²ï¼Œç¯ç¬¼ï¼Œé­ç‚®<br>
                            â€¢ ä¸­ç§‹èŠ‚ - æœˆå…”å«¦å¨¥ï¼Œè“è‰²èƒŒæ™¯ï¼Œæ¸©é¦¨æ°›å›´<br>
                            â€¢ å…ƒå®µèŠ‚ - èŠ±ç¯ã€æ±¤åœ†ï¼Œçƒ­é—¹èŠ‚æ—¥åœºæ™¯
                        </div>
                    </div>
                `;
            }

            // å¦‚æœå·¥å…·æœ‰è¾“å…¥å­—æ®µ,æ·»åŠ å‚æ•°è¾“å…¥ç•Œé¢
            if (tool.input_fields && tool.input_fields.length > 0) {
                // æ ¹æ®å·¥å…·ç±»å‹è®¾ç½®æ ‡é¢˜
                let title = "å‚æ•°è®¾ç½®";
                if (tool.filename === 'article/toutiao_article_generator.py') {
                    title = "ğŸ“ æ–‡ç« å‚æ•°è®¾ç½®";
                } else if (tool.filename === 'video/baidu_video_downloader.py') {
                    title = "ğŸ¬ è§†é¢‘ä¸‹è½½è®¾ç½®";
                }

                html += `
                    <div class="params-input-container" style="background: #1e1e2e; padding: 20px; border-radius: 10px; border-left: 3px solid #5a67d8; margin-top: 15px;">
                        <h4 style="color: #5a67d8; margin-bottom: 15px;">${title}</h4>
                `;

                // ä¸ºæ¯ä¸ªè¾“å…¥å­—æ®µåˆ›å»ºç•Œé¢
                tool.input_fields.forEach(field => {
                    if (field.type === 'text') {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #c5c5e0; margin-bottom: 8px;">${field.label} ${field.required ? '<span style="color: #e53e3e;">*</span>' : ''}</label>
                                <input
                                    type="text"
                                    class="param-input"
                                    id="param-${field.name}"
                                    placeholder="${field.placeholder}"
                                    style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; border-radius: 5px; color: #e2e8f0; font-size: 14px;"
                                    ${field.required ? 'required' : ''}
                                >
                            </div>
                        `;
                    } else if (field.type === 'textarea') {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #c5c5e0; margin-bottom: 8px;">${field.label} ${field.required ? '<span style="color: #e53e3e;">*</span>' : ''}</label>
                                <textarea
                                    class="param-input"
                                    id="param-${field.name}"
                                    placeholder="${field.placeholder}"
                                    rows="8"
                                    style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; border-radius: 5px; color: #e2e8f0; font-size: 14px; font-family: inherit; resize: vertical;"
                                    ${field.required ? 'required' : ''}
                                ></textarea>
                            </div>
                        `;
                    } else if (field.type === 'select') {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #c5c5e0; margin-bottom: 8px;">${field.label}</label>
                                <select
                                    class="param-input"
                                    id="param-${field.name}"
                                    style="width: 100%; padding: 10px; background: #2d3748; border: 1px solid #4a5568; border-radius: 5px; color: #e2e8f0; font-size: 14px;"
                                    onchange="handleModeChange()"
                                >
                                    ${field.options.map(opt =>
                                        `<option value="${opt.value}">${opt.label}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                    }
                });

                // æ ¹æ®å·¥å…·ç±»å‹æ·»åŠ ç¤ºä¾‹æç¤º
                if (tool.filename === 'article/toutiao_article_generator.py') {
                    html += `
                        <div style="margin-top: 15px; padding: 12px; background: #2d3748; border-radius: 5px; border-left: 3px solid #6b46c1;">
                            <strong style="color: #6b46c1;">ğŸ’¡ çƒ­é—¨ä¸»é¢˜ç¤ºä¾‹:</strong><br>
                            <span style="color: #c5c5e0; font-size: 0.9em;">
                            â€¢ è¿‡å¹´å›è€å®¶ - æƒ…æ„Ÿå…±é¸£å¼º<br>
                            â€¢ èŒåœºæ–°äººå¿…çœ‹ - å®ç”¨ä»·å€¼é«˜<br>
                            â€¢ 30å²åæ‰æ˜ç™½çš„çœŸç›¸ - å¼•å‘å¥½å¥‡<br>
                            â€¢ è¿™3ä¸ªä¹ æƒ¯è®©æˆ‘å¹´å…¥ç™¾ä¸‡ - æ•°å­—åˆºæ¿€
                            </span>
                        </div>
                    `;
                } else if (tool.filename === 'video/baidu_video_downloader.py') {
                    html += `
                        <div style="margin-top: 15px; padding: 12px; background: #2d3748; border-radius: 5px; border-left: 3px solid #48bb78;">
                            <strong style="color: #48bb78;">ğŸ’¡ æ”¯æŒçš„è§†é¢‘å¹³å°:</strong><br>
                            <span style="color: #c5c5e0; font-size: 0.9em;">
                            â€¢ ç™¾åº¦æ–°é—» (mbd.baidu.com)<br>
                            â€¢ ç™¾å®¶å· (baijiahao.baidu.com)<br>
                            â€¢ ç™¾åº¦è§†é¢‘ (haokan.baidu.com)
                            </span>
                        </div>
                    `;
                }
            }

            html += `
                    <button class="run-button" onclick="runTool()">â–¶ è¿è¡Œå·¥å…·</button>
                </div>
            `;

            // æ·»åŠ æŠ€æœ¯æ ˆå¡ç‰‡
            if (techStack.length > 0) {
                html += `
                    <div class="detail-card" style="margin-top: 20px;">
                        <h3>ğŸ› ï¸ æŠ€æœ¯æ ˆ</h3>
                        <div style="margin-top: 10px;">
                            ${techStack.map(tech =>
                                `<span style="display: inline-block; background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); color: white; padding: 6px 14px; margin: 4px; border-radius: 20px; font-size: 0.9em; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${tech}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            // åœ¨è¿è¡Œå·¥å…·æŒ‰é’®åæ·»åŠ ä¸»è¦å‡½æ•°å’Œä¸»è¦ç±»
            if (docInfo) {
                html += `<div class="detail-card" style="margin-top: 20px;">`;

                // æ·»åŠ ä¸»è¦å‡½æ•°
                if (docInfo.main_functions && docInfo.main_functions.length > 0) {
                    html += `
                        <h3>ğŸ“‹ ä¸»è¦å‡½æ•°</h3>
                        <div style="color: #c5c5e0; margin-top: 10px; padding: 12px; background: #1e1e2e; border-radius: 5px;">
                            ${docInfo.main_functions.slice(0, 8).map(func =>
                                `<div style="padding: 4px 0;">â€¢ <code style="color: #4299e1;">${func}</code></div>`
                            ).join('')}
                            ${docInfo.main_functions.length > 8 ? `<div style="padding: 8px 0; color: #888; font-style: italic;">... è¿˜æœ‰ ${docInfo.main_functions.length - 8} ä¸ªå‡½æ•°</div>` : ''}
                        </div>
                    `;
                }

                // æ·»åŠ ä¸»è¦ç±»
                if (docInfo.classes && docInfo.classes.length > 0) {
                    html += `
                        <h3 style="margin-top: 20px;">ğŸ—ï¸ ä¸»è¦ç±»</h3>
                        <div style="margin-top: 10px;">
                            ${docInfo.classes.map(cls =>
                                `<span style="display: inline-block; background: #48bb78; color: white; padding: 6px 12px; margin: 4px; border-radius: 4px; font-size: 0.9em;">${cls}</span>`
                            ).join('')}
                        </div>
                    `;
                }

                html += `</div>`;
            }

            detailsDiv.innerHTML = html;

            // æ¢å¤ä¹‹å‰ä¿å­˜çš„å‚æ•°
            const savedParams = restoreToolParams(tool.filename);
            if (savedParams) {
                setTimeout(() => {
                    tool.input_fields.forEach(field => {
                        const input = document.getElementById(`param-${field.name}`);
                        if (input && savedParams[field.name]) {
                            input.value = savedParams[field.name];
                        }
                    });
                    // è§¦å‘æ¨¡å¼å˜åŒ–å¤„ç†ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    if (savedParams['mode']) {
                        handleModeChange();
                    }
                }, 100);
            }
        }

        // ä¿å­˜å·¥å…·å‚æ•°åˆ°localStorage
        function saveToolParams(toolFilename, params) {
            try {
                const key = `tool_params_${toolFilename}`;
                localStorage.setItem(key, JSON.stringify(params));
            } catch (e) {
                console.warn('æ— æ³•ä¿å­˜å‚æ•°åˆ°localStorage:', e);
            }
        }

        // ä»localStorageæ¢å¤å·¥å…·å‚æ•°
        function restoreToolParams(toolFilename) {
            try {
                const key = `tool_params_${toolFilename}`;
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                console.warn('æ— æ³•ä»localStorageæ¢å¤å‚æ•°:', e);
                return null;
            }
        }

        // è¿è¡Œå·¥å…·
        // å¤„ç†ç”Ÿæˆæ¨¡å¼å˜åŒ–
        function handleModeChange() {
            const mode = document.getElementById('param-mode')?.value;
            if (!mode) return;

            const themeField = document.getElementById('param-theme')?.parentElement;
            const draftField = document.getElementById('param-draft')?.parentElement;

            if (mode === '1') {
                // ä¸»é¢˜ç”Ÿæˆæ¨¡å¼ - æ˜¾ç¤ºä¸»é¢˜è¾“å…¥,éšè—è‰ç¨¿è¾“å…¥
                if (themeField) themeField.style.display = 'block';
                if (draftField) draftField.style.display = 'none';
            } else if (mode === '2') {
                // è‰ç¨¿å®Œå–„æ¨¡å¼ - éšè—ä¸»é¢˜è¾“å…¥,æ˜¾ç¤ºè‰ç¨¿è¾“å…¥
                if (themeField) themeField.style.display = 'none';
                if (draftField) draftField.style.display = 'block';
            }
        }

        async function runTool() {
            if (!currentTool) return;

            const btn = document.querySelector('.run-button');
            btn.disabled = true;
            btn.textContent = 'â³ å¯åŠ¨ä¸­...';
            btn.classList.add('running');

            // æ·»åŠ æ—¥å¿—
            addLog('info', `å¼€å§‹è¿è¡Œ: ${currentTool.description}`);

            try {
                const requestData = {
                    filename: currentTool.filename
                };

                // å¦‚æœæ˜¯èŠ‚æ—¥å›¾åƒç”Ÿæˆå™¨,è·å–ä¸»é¢˜
                if (currentTool.filename === 'picture/generate_festival_images.py') {
                    const theme = document.getElementById('theme-input').value;
                    if (theme) {
                        requestData.params = { theme: theme };
                        // ä¿å­˜å‚æ•°åˆ°localStorage
                        saveToolParams(currentTool.filename, requestData.params);
                        addLog('info', `ä¸»é¢˜: ${theme}`);
                    }
                }

                // å¦‚æœæ˜¯ä»Šæ—¥å¤´æ¡æ–‡ç« ç”Ÿæˆå™¨,è·å–æ¨¡å¼ã€ä¸»é¢˜/è‰ç¨¿ã€å­—æ•°å’Œé…å›¾å‚æ•°
                if (currentTool.filename === 'article/toutiao_article_generator.py') {
                    const mode = document.getElementById('param-mode')?.value || '1';
                    const theme = document.getElementById('param-theme')?.value || '';
                    const draft = document.getElementById('param-draft')?.value || '';
                    const length = document.getElementById('param-length')?.value || '2000';
                    const style = document.getElementById('param-style')?.value || 'standard';
                    const generateImages = document.getElementById('param-generate_images')?.value || 'y';
                    const imageStyle = document.getElementById('param-image_style')?.value || 'realistic';

                    // éªŒè¯å‚æ•°
                    if (mode === '1' && !theme) {
                        addLog('error', 'è¯·è¾“å…¥æ–‡ç« ä¸»é¢˜');
                        btn.disabled = false;
                        btn.textContent = 'â–¶ï¸ è¿è¡Œå·¥å…·';
                        btn.classList.remove('running');
                        return;
                    }
                    if (mode === '2' && !draft) {
                        addLog('error', 'è¯·è¾“å…¥æ–‡ç« è‰ç¨¿');
                        btn.disabled = false;
                        btn.textContent = 'â–¶ï¸ è¿è¡Œå·¥å…·';
                        btn.classList.remove('running');
                        return;
                    }

                    // æ ¹æ®æ¨¡å¼æ„å»ºå‚æ•° - è‰ç¨¿å®Œå–„æ¨¡å¼ä¸ä¼ é€’themeå‚æ•°
                    let params = {
                        mode: mode,
                        length: length,
                        style: style,
                        generate_images: generateImages,
                        image_style: imageStyle
                    };

                    if (mode === '1') {
                        // ä¸»é¢˜ç”Ÿæˆæ¨¡å¼ - ä¼ é€’theme
                        params.theme = theme;
                    } else if (mode === '2') {
                        // è‰ç¨¿å®Œå–„æ¨¡å¼ - ä¼ é€’draft,ä¸ä¼ é€’theme
                        params.draft = draft;
                    }

                    requestData.params = params;

                    // ä¿å­˜å‚æ•°åˆ°localStorage
                    saveToolParams(currentTool.filename, requestData.params);

                    const modeNames = { '1': 'ä¸»é¢˜ç”Ÿæˆ', '2': 'è‰ç¨¿å®Œå–„' };
                    addLog('info', `æ¨¡å¼: ${modeNames[mode]}`);
                    if (mode === '1') {
                        addLog('info', `ä¸»é¢˜: ${theme}`);
                    } else {
                        addLog('info', `è‰ç¨¿: ${draft.substring(0, 50)}...`);
                    }
                    addLog('info', `å­—æ•°: ${length}å­—`);
                    addLog('info', `ç”Ÿæˆé…å›¾: ${generateImages === 'y' ? 'æ˜¯' : 'å¦'}`);
                    if (generateImages === 'y') {
                        const styleNames = { 'realistic': 'çœŸå®ç…§ç‰‡', 'artistic': 'è‰ºæœ¯åˆ›ä½œ', 'cartoon': 'å¡é€šæ’ç”»' };
                        addLog('info', `é…å›¾é£æ ¼: ${styleNames[imageStyle]}`);
                    }
                }

                // å¦‚æœæ˜¯ç™¾åº¦è§†é¢‘ä¸‹è½½å™¨,è·å–URLå’Œè¾“å‡ºæ–‡ä»¶å
                if (currentTool.filename === 'video/baidu_video_downloader.py') {
                    const url = document.getElementById('param-url').value;
                    const outputFilename = document.getElementById('param-output_filename').value;

                    if (!url) {
                        addLog('error', 'è¯·è¾“å…¥è§†é¢‘URL');
                        btn.disabled = false;
                        btn.textContent = 'â–¶ï¸ è¿è¡Œå·¥å…·';
                        btn.classList.remove('running');
                        return;
                    }

                    requestData.params = {
                        url: url,
                        output_filename: outputFilename
                    };

                    // ä¿å­˜å‚æ•°åˆ°localStorage
                    saveToolParams(currentTool.filename, requestData.params);

                    addLog('info', `è§†é¢‘URL: ${url}`);
                    if (outputFilename) {
                        addLog('info', `è¾“å‡ºæ–‡ä»¶: ${outputFilename}`);
                    } else {
                        addLog('info', `è¾“å‡ºæ–‡ä»¶: è‡ªåŠ¨ç”Ÿæˆ`);
                    }
                }

                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.success) {
                    currentProcessId = data.process_id;
                    addLog('success', `å·¥å…·å·²å¯åŠ¨: ${data.message}`);

                    // æ›´æ–°æ ‘èŠ‚ç‚¹çŠ¶æ€
                    const toolElement = document.querySelector(`[data-filename="${currentTool.filename}"]`);
                    if (toolElement) {
                        toolElement.classList.add('running');
                    }

                    // å¼€å§‹æ£€æŸ¥çŠ¶æ€
                    btn.textContent = 'ğŸ”„ è¿è¡Œä¸­...';
                    checkStatus();

                } else {
                    addLog('error', `å¯åŠ¨å¤±è´¥: ${data.error}`);
                    btn.disabled = false;
                    btn.textContent = 'â–¶ è¿è¡Œå·¥å…·';
                    btn.classList.remove('running');
                }

            } catch (error) {
                addLog('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'â–¶ è¿è¡Œå·¥å…·';
                btn.classList.remove('running');
            }
        }

        // æ£€æŸ¥è¿è¡ŒçŠ¶æ€
        async function checkStatus() {
            if (!currentProcessId) return;

            try {
                const response = await fetch(`/api/status/${currentProcessId}`);
                const data = await response.json();

                if (data.success) {
                    if (data.status === 'running') {
                        addLog('info', `è¿è¡Œä¸­... (${data.elapsed_time}ç§’)`);
                        statusCheckInterval = setTimeout(checkStatus, 2000);
                    } else {
                        // å®Œæˆ
                        clearInterval(statusCheckInterval);

                        const toolElement = document.querySelector(`[data-filename="${currentTool.filename}"]`);
                        if (toolElement) {
                            toolElement.classList.remove('running');
                            toolElement.classList.add(data.status);
                        }

                        if (data.status === 'completed') {
                            addLog('success', `âœ“ è¿è¡Œå®Œæˆ! è€—æ—¶: ${data.elapsed_time}ç§’`);
                            if (data.output) {
                                addLog('info', 'è¾“å‡ºç»“æœ:\n' + data.output);

                                // æ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„HTMLæ–‡ä»¶å¹¶æ·»åŠ å¯ç‚¹å‡»é“¾æ¥
                                const htmlMatch = data.output.match(/\[OUTPUT\] HTML: (.+\.html)/);
                                if (htmlMatch) {
                                    const htmlFile = htmlMatch[1].trim();
                                    const viewUrl = `/view/article/${htmlFile}`;
                                    // æ·»åŠ å¯ç‚¹å‡»çš„é“¾æ¥åˆ°æ—¥å¿—
                                    addLogWithLink('success', `ğŸ“„ ç‚¹å‡»æŸ¥çœ‹æ–‡ç« : `, htmlFile, viewUrl);
                                }
                            }
                        } else {
                            addLog('error', `âœ— è¿è¡Œå¤±è´¥ (é€€å‡ºç : ${data.returncode})`);
                            if (data.output) {
                                addLog('error', 'é”™è¯¯è¾“å‡º:\n' + data.output);
                            }
                        }

                        const btn = document.querySelector('.run-button');
                        btn.disabled = false;
                        btn.textContent = 'â–¶ è¿è¡Œå·¥å…·';
                        btn.classList.remove('running');

                        updateStats();
                    }
                }

            } catch (error) {
                addLog('error', `çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(type, message) {
            const logContent = document.getElementById('log-content');
            const now = new Date();
            const time = now.toLocaleTimeString('zh-CN');

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-message">${message}</span>
            `;

            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // æ·»åŠ å¸¦å¯ç‚¹å‡»é“¾æ¥çš„æ—¥å¿—
        function addLogWithLink(type, message, linkText, linkUrl) {
            const logContent = document.getElementById('log-content');
            const now = new Date();
            const time = now.toLocaleTimeString('zh-CN');

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-message">${message}<a href="${linkUrl}" target="_blank" style="color: #4299e1; text-decoration: underline; font-weight: bold;">${linkText}</a></span>
            `;

            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('log-content').innerHTML = '';
            addLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
        }

        // åˆ é™¤å·¥å…·
        async function deleteTool(tool, element) {
            // æå–å·¥å…·åç§°
            let toolName = tool.description;
            if (toolName.includes(' - ')) {
                toolName = toolName.split(' - ')[1];
            }
            if (toolName.includes(' (')) {
                toolName = toolName.split(' (')[0];
            }

            // ç¡®è®¤åˆ é™¤
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å·¥å…·å—ï¼Ÿ\n\nå·¥å…·: ${toolName}\næ–‡ä»¶: ${tool.filename}\n\næ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥æ–‡ä»¶ï¼Œæ— æ³•æ¢å¤ï¼`)) {
                return;
            }

            addLog('warning', `æ­£åœ¨åˆ é™¤å·¥å…·: ${toolName}`);

            try {
                const response = await fetch('/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: tool.filename
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addLog('success', `âœ“ å·¥å…·å·²åˆ é™¤: ${tool.filename}`);

                    // ä»UIä¸­ç§»é™¤
                    element.style.transition = 'all 0.3s';
                    element.style.opacity = '0';
                    element.style.transform = 'translateX(-100%)';

                    setTimeout(() => {
                        element.remove();
                        updateStats();

                        // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¢«åˆ é™¤çš„å·¥å…·ï¼Œæ¸…ç©ºè¯¦æƒ…åŒº
                        if (currentTool && currentTool.filename === tool.filename) {
                            document.getElementById('tool-title').textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªå·¥å…·';
                            document.getElementById('tool-description').textContent = 'ä»å·¦ä¾§ç›®å½•æ ‘ä¸­é€‰æ‹©è¦è¿è¡Œçš„å·¥å…·';
                            document.getElementById('tool-details').innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-state-icon">ğŸ‘ˆ</div>
                                    <p>ç‚¹å‡»å·¦ä¾§ç›®å½•é€‰æ‹©å·¥å…·</p>
                                </div>
                            `;
                            currentTool = null;
                        }
                    }, 300);

                } else {
                    addLog('error', `åˆ é™¤å¤±è´¥: ${data.error}`);
                }

            } catch (error) {
                addLog('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°æ–‡æ¡£
        async function updateDocumentation() {
            const btn = document.querySelector('.update-docs-button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'â³ æ›´æ–°ä¸­...';

            addLog('info', 'å¼€å§‹æ›´æ–°å·¥å…·æ–‡æ¡£...');

            try {
                const response = await fetch('/api/update-documentation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    addLog('success', 'âœ“ æ–‡æ¡£å·²æˆåŠŸæ›´æ–°');
                    if (data.output) {
                        // è§£æè¾“å‡ºä¸­çš„ç»Ÿè®¡ä¿¡æ¯
                        const lines = data.output.split('\n');
                        const summaryLine = lines.find(line => line.includes('å…±åˆ†æ'));
                        if (summaryLine) {
                            addLog('info', summaryLine.trim());
                        }
                    }

                    // å¦‚æœå½“å‰é€‰ä¸­çš„å·¥å…·ï¼Œåˆ·æ–°è¯¦æƒ…æ˜¾ç¤º
                    if (currentTool) {
                        const toolElement = document.querySelector('.tree-tool.selected');
                        if (toolElement) {
                            await selectTool(currentTool, toolElement);
                        }
                    }
                } else {
                    addLog('error', `æ›´æ–°å¤±è´¥: ${data.error}`);
                }

            } catch (error) {
                addLog('error', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('total-categories').textContent = Object.keys(toolsData).length;

            let totalTools = 0;
            for (const tools of Object.values(toolsData)) {
                totalTools += tools.length;
            }
            document.getElementById('total-tools').textContent = totalTools;

            const runningCount = document.querySelectorAll('.tree-tool.running').length;
            document.getElementById('running-count').textContent = runningCount;
        }
    </script>
</body>
</html>
