# Gemini模型对比测试 - 断点续传功能说明

## 功能概述

测试工具现在支持**断点续传**功能,可以在API配额用尽或测试中断后,继续完成剩余的测试任务。

## 工作原理

### 1. 进度保存
- 每完成一个任务(成功或失败),自动保存进度到 `test_progress.json`
- 进度文件包含:
  - 已完成的任务列表
  - 所有测试结果
  - 时间戳信息

### 2. 断点恢复
- 重新运行工具时,自动检测进度文件
- 跳过已完成的任务
- 只执行未完成的任务

### 3. 任务标识
每个任务由唯一标识符组成: `{model_id}_{category}_{index}`

例如:
- `gemini-3-pro-image-4k_art_1` - Gemini 4K模型,艺术类,第1个提示词
- `gemini-3-flash-image_animal_2` - Gemini Flash模型,动物类,第2个提示词

## 使用方法

### 首次运行
```bash
cd test
python test_gemini_pro_image.py
```

输出示例:
```
================================================================================
Gemini全模型对比测试工具
================================================================================

[OK] API客户端初始化成功

[新测试] 输出目录: gemini_comparison_output/
[新测试] 测试模型数: 5
[新测试] 测试提示词数: 5
[新测试] 总计生成: 25 张图像
```

### 断点后续运行
如果测试因配额限制中断:

```bash
python test_gemini_pro_image.py
```

输出示例:
```
================================================================================
Gemini全模型对比测试工具
================================================================================

[OK] API客户端初始化成功

[INFO] 发现已保存的测试进度
[INFO] 上次测试时间: 20260129_085418
[INFO] 已完成: 16/25

[恢复模式] 将跳过已完成的 16 个任务
[恢复模式] 剩余任务: 9/25

--------------------------------------------------------------------------------

[模型] Gemini 2 Pro Image (gemini-2-pro-image)
  说明: 第二代专业图像模型
  尺寸: 1024x1024

  [2/5] [SKIP] 可爱猫咪 (已完成)

  [3/5] 未来城市
    Prompt: Futuristic cyberpunk city at night, neon lights, flying cars...
```

### 完成提示
当测试完成(包括部分成功)时:

```
[提示] 有 9 个任务未成功完成
[提示] 您可以稍后重新运行此工具,它将自动跳过已完成的任务
[提示] 进度已保存在: gemini_comparison_output/test_progress.json
```

## 重新开始测试

如果想要完全重新开始测试:

### 方法1: 删除进度文件
```bash
rm gemini_comparison_output/test_progress.json
```

### 方法2: 删除整个输出目录
```bash
rm -rf gemini_comparison_output
```

## 进度文件格式

`test_progress.json` 示例:
```json
{
  "timestamp": "20260129_085418",
  "completed_count": 16,
  "total_count": 25,
  "completed_tasks": [
    "gemini-3-pro-image-4k_art_1",
    "gemini-3-pro-image-4k_animal_2",
    ...
  ],
  "all_results": {
    "gemini-3-pro-image-4k": {
      "model_info": {...},
      "results": [...],
      "success_count": 5,
      "total_count": 5
    },
    ...
  }
}
```

## 常见场景

### 场景1: API配额用尽
1. 运行测试
2. 生成16张图片后遇到429错误
3. 工具自动保存进度
4. 等待4小时后重新运行
5. 工具自动跳过已完成的16张,只尝试剩余9张

### 场景2: 手动中断(Ctrl+C)
1. 运行测试
2. 按Ctrl+C中断
3. 已完成的任务已保存
4. 重新运行时从中断处继续

### 场景3: 部分失败
1. 某些模型遇到配额限制
2. 成功的任务被标记为完成
3. 失败的任务也被标记为完成(避免重复尝试失败的任务)
4. 如需重试失败的任务,删除进度文件重新开始

## 优势

✅ **节省时间** - 不用重新生成已成功的图片
✅ **节省配额** - 避免重复调用API
✅ **灵活恢复** - 随时中断,随时继续
✅ **进度可见** - 清楚知道已完成多少,剩余多少
✅ **自动保存** - 每完成一个任务就保存,不怕数据丢失

## 文件说明

### 生成的文件

1. **test_progress.json** - 进度文件(可删除)
   - 保存测试进度和中间结果
   - 用于断点续传

2. **test_results_*.json** - 最终结果文件(保留)
   - 完整的测试结果
   - 每次运行生成新的时间戳文件

3. **gemini_models_comparison_*.html** - HTML对比页面(保留)
   - 可视化展示所有生成的图片
   - 包含性能对比表格

4. ***.png** - 生成的图片(保留)
   - 所有成功生成的图片文件

## 注意事项

⚠️ **失败任务不会重试**
- 为了避免陷入失败循环,失败的任务也会被标记为完成
- 如需重试失败的任务,请删除进度文件重新开始

⚠️ **进度文件格式**
- 进度文件格式可能会随版本更新而变化
- 建议使用相同版本的测试工具进行断点续传

⚠️ **文件名冲突**
- 断点续传会使用相同的文件名
- 确保不要手动删除已生成的图片文件

## 完整示例

```bash
# 首次运行
python test_gemini_pro_image.py

# 输出:
# [新测试] 总计生成: 25 张图像
# ...
# [提示] 有 9 个任务未成功完成
# [提示] 进度已保存在: gemini_comparison_output/test_progress.json

# 等待配额恢复后,再次运行
python test_gemini_pro_image.py

# 输出:
# [INFO] 发现已保存的测试进度
# [INFO] 已完成: 16/25
# [恢复模式] 将跳过已完成的 16 个任务
# [恢复模式] 剩余任务: 9/25
# ...
# [提示] 所有任务已完成! 可以删除进度文件重新开始测试

# 删除进度文件,准备下次全新测试
rm gemini_comparison_output/test_progress.json
```

---

**版本**: v1.0
**更新日期**: 2026-01-29
**作者**: AI发文工具管理器
